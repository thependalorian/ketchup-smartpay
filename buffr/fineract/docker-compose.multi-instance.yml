# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements. See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership. The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License. You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.
#
# Multi-Instance Fineract Setup for Production
# Supports: Write instance, Read instances (2), Batch instance
# Database: PostgreSQL 17.0+ with read-replica

version: "3.8"

services:
  # ============================================================================
  # DATABASE: Primary (Write)
  # ============================================================================
  db-primary:
    image: postgres:17.0
    container_name: fineract-db-primary
    environment:
      POSTGRES_DB: ${FINERACT_DB_NAME:-fineract}
      POSTGRES_USER: ${FINERACT_DB_USER:-fineract}
      POSTGRES_PASSWORD: ${FINERACT_DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      TZ: UTC  # MANDATORY: UTC timezone required
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - db-primary-data:/var/lib/postgresql/data
    ports:
      - "${DB_PRIMARY_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${FINERACT_DB_USER:-fineract} -d ${FINERACT_DB_NAME:-fineract}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - fineract-network
    restart: unless-stopped

  # ============================================================================
  # DATABASE: Read-Replica
  # ============================================================================
  db-replica:
    image: postgres:17.0
    container_name: fineract-db-replica
    environment:
      POSTGRES_DB: ${FINERACT_DB_NAME:-fineract}
      POSTGRES_USER: ${FINERACT_DB_USER:-fineract}
      POSTGRES_PASSWORD: ${FINERACT_DB_PASSWORD}
      POSTGRES_MASTER_SERVICE_HOST: db-primary
      POSTGRES_MASTER_SERVICE_PORT: 5432
      POSTGRES_REPLICATION_USER: ${POSTGRES_REPLICATION_USER:-replication}
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
      TZ: UTC  # MANDATORY: UTC timezone required
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - db-replica-data:/var/lib/postgresql/data
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/setup-replication.sh
    ports:
      - "${DB_REPLICA_PORT:-5433}:5432"
    depends_on:
      db-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${FINERACT_DB_USER:-fineract} -d ${FINERACT_DB_NAME:-fineract}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - fineract-network
    restart: unless-stopped

  # ============================================================================
  # FINERACT: Write Instance (Primary)
  # ============================================================================
  fineract-write:
    extends:
      file: ./config/docker/compose/fineract.yml
      service: fineract
    container_name: fineract-write
    environment:
      # Database Configuration (Primary)
      FINERACT_DB_HOST: db-primary
      FINERACT_DB_PORT: 5432
      FINERACT_DB_NAME: ${FINERACT_DB_NAME:-fineract}
      FINERACT_DB_USER: ${FINERACT_DB_USER:-fineract}
      FINERACT_DB_PASSWORD: ${FINERACT_DB_PASSWORD}
      FINERACT_DB_DRIVER: org.postgresql.Driver
      FINERACT_DB_URL: jdbc:postgresql://db-primary:5432/${FINERACT_DB_NAME:-fineract}
      
      # SSL Configuration (MANDATORY for production)
      FINERACT_SERVER_SSL_ENABLED: ${FINERACT_SERVER_SSL_ENABLED:-true}
      FINERACT_SERVER_SSL_KEYSTORE: ${FINERACT_SERVER_SSL_KEYSTORE:-/keystore/fineract-keystore.jks}
      FINERACT_SERVER_SSL_KEYSTORE_PASSWORD: ${FINERACT_SERVER_SSL_KEYSTORE_PASSWORD}
      
      # Timezone (MANDATORY: UTC)
      TZ: UTC
      JAVA_OPTS: ${JAVA_OPTS:-"-Duser.timezone=UTC"}
      
      # Instance Type
      FINERACT_INSTANCE_TYPE: write
    ports:
      - "${FINERACT_WRITE_PORT:-8443}:8443"
    depends_on:
      db-primary:
        condition: service_healthy
    networks:
      - fineract-network
    restart: unless-stopped
    volumes:
      - ./keystore:/keystore:ro

  # ============================================================================
  # FINERACT: Read Instance 1
  # ============================================================================
  fineract-read-1:
    extends:
      file: ./config/docker/compose/fineract.yml
      service: fineract
    container_name: fineract-read-1
    environment:
      # Database Configuration (Read-Replica)
      FINERACT_DB_HOST: db-replica
      FINERACT_DB_PORT: 5432
      FINERACT_DB_NAME: ${FINERACT_DB_NAME:-fineract}
      FINERACT_DB_USER: ${FINERACT_DB_USER:-fineract}
      FINERACT_DB_PASSWORD: ${FINERACT_DB_PASSWORD}
      FINERACT_DB_DRIVER: org.postgresql.Driver
      FINERACT_DB_URL: jdbc:postgresql://db-replica:5432/${FINERACT_DB_NAME:-fineract}
      
      # SSL Configuration (MANDATORY for production)
      FINERACT_SERVER_SSL_ENABLED: ${FINERACT_SERVER_SSL_ENABLED:-true}
      FINERACT_SERVER_SSL_KEYSTORE: ${FINERACT_SERVER_SSL_KEYSTORE:-/keystore/fineract-keystore.jks}
      FINERACT_SERVER_SSL_KEYSTORE_PASSWORD: ${FINERACT_SERVER_SSL_KEYSTORE_PASSWORD}
      
      # Timezone (MANDATORY: UTC)
      TZ: UTC
      JAVA_OPTS: ${JAVA_OPTS:-"-Duser.timezone=UTC"}
      
      # Instance Type
      FINERACT_INSTANCE_TYPE: read
    ports:
      - "${FINERACT_READ_1_PORT:-8444}:8443"
    depends_on:
      db-replica:
        condition: service_healthy
    networks:
      - fineract-network
    restart: unless-stopped
    volumes:
      - ./keystore:/keystore:ro

  # ============================================================================
  # FINERACT: Read Instance 2
  # ============================================================================
  fineract-read-2:
    extends:
      file: ./config/docker/compose/fineract.yml
      service: fineract
    container_name: fineract-read-2
    environment:
      # Database Configuration (Read-Replica)
      FINERACT_DB_HOST: db-replica
      FINERACT_DB_PORT: 5432
      FINERACT_DB_NAME: ${FINERACT_DB_NAME:-fineract}
      FINERACT_DB_USER: ${FINERACT_DB_USER:-fineract}
      FINERACT_DB_PASSWORD: ${FINERACT_DB_PASSWORD}
      FINERACT_DB_DRIVER: org.postgresql.Driver
      FINERACT_DB_URL: jdbc:postgresql://db-replica:5432/${FINERACT_DB_NAME:-fineract}
      
      # SSL Configuration (MANDATORY for production)
      FINERACT_SERVER_SSL_ENABLED: ${FINERACT_SERVER_SSL_ENABLED:-true}
      FINERACT_SERVER_SSL_KEYSTORE: ${FINERACT_SERVER_SSL_KEYSTORE:-/keystore/fineract-keystore.jks}
      FINERACT_SERVER_SSL_KEYSTORE_PASSWORD: ${FINERACT_SERVER_SSL_KEYSTORE_PASSWORD}
      
      # Timezone (MANDATORY: UTC)
      TZ: UTC
      JAVA_OPTS: ${JAVA_OPTS:-"-Duser.timezone=UTC"}
      
      # Instance Type
      FINERACT_INSTANCE_TYPE: read
    ports:
      - "${FINERACT_READ_2_PORT:-8445}:8443"
    depends_on:
      db-replica:
        condition: service_healthy
    networks:
      - fineract-network
    restart: unless-stopped
    volumes:
      - ./keystore:/keystore:ro

  # ============================================================================
  # FINERACT: Batch Instance (Scheduled Jobs)
  # ============================================================================
  fineract-batch:
    extends:
      file: ./config/docker/compose/fineract.yml
      service: fineract
    container_name: fineract-batch
    environment:
      # Database Configuration (Read-Replica for reporting)
      FINERACT_DB_HOST: db-replica
      FINERACT_DB_PORT: 5432
      FINERACT_DB_NAME: ${FINERACT_DB_NAME:-fineract}
      FINERACT_DB_USER: ${FINERACT_DB_USER:-fineract}
      FINERACT_DB_PASSWORD: ${FINERACT_DB_PASSWORD}
      FINERACT_DB_DRIVER: org.postgresql.Driver
      FINERACT_DB_URL: jdbc:postgresql://db-replica:5432/${FINERACT_DB_NAME:-fineract}
      
      # SSL Configuration (MANDATORY for production)
      FINERACT_SERVER_SSL_ENABLED: ${FINERACT_SERVER_SSL_ENABLED:-true}
      FINERACT_SERVER_SSL_KEYSTORE: ${FINERACT_SERVER_SSL_KEYSTORE:-/keystore/fineract-keystore.jks}
      FINERACT_SERVER_SSL_KEYSTORE_PASSWORD: ${FINERACT_SERVER_SSL_KEYSTORE_PASSWORD}
      
      # Timezone (MANDATORY: UTC)
      TZ: UTC
      JAVA_OPTS: ${JAVA_OPTS:-"-Duser.timezone=UTC"}
      
      # Instance Type
      FINERACT_INSTANCE_TYPE: batch
    ports:
      - "${FINERACT_BATCH_PORT:-8446}:8443"
    depends_on:
      db-replica:
        condition: service_healthy
    networks:
      - fineract-network
    restart: unless-stopped
    volumes:
      - ./keystore:/keystore:ro

  # ============================================================================
  # NGINX: Reverse Proxy (SSL Termination & Load Balancing)
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: fineract-nginx
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - fineract-write
      - fineract-read-1
      - fineract-read-2
    networks:
      - fineract-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  fineract-network:
    driver: bridge

volumes:
  db-primary-data:
    driver: local
  db-replica-data:
    driver: local
