# Ketchup – Voucher Operations (Assign, Generate, Issue, Buffr, USSD)

**Purpose:** Reference for Ketchup CRUD and distribution: assign vouchers to beneficiaries, generate codes, issue vouchers, distribute to Buffr app and USSD.  
**Location:** `smartpay-connect/docs/KETCHUP_VOUCHER_OPERATIONS.md`

---

## 1. Assign = Issue to Beneficiary

**Footnote:** Proxy collectors (authorised to collect on behalf) and **dependants** (child, spouse, guardian) are implemented: proxy/dependant data and Ketchup UI for dependants and “Mark deceased” are in place. **Death:** Beneficiaries can be marked deceased; no new vouchers are issued to deceased beneficiaries (issuance guard in `VoucherService`). Death-to-dependent **redirect rules** (reassign benefits to dependants per grant type) are designed but not yet implemented; see **FOOTNOTES_FUTURE.md**.

Ketchup **assigns** every voucher to a beneficiary at creation time. There is no “unassigned” voucher; issuing a voucher **is** assigning it.

| Operation | Method | Endpoint | Body | Notes |
|-----------|--------|----------|------|--------|
| **Issue (assign) single voucher** | POST | `/api/v1/vouchers` | `{ beneficiaryId, amount, grantType?, expiryDays?, scheduledIssueAt?, buffrUserId? }` | `beneficiaryId` and `amount` required. Optional `buffrUserId` (Buffr wallet UUID) for distribution; optional `scheduledIssueAt` (ISO date/datetime, not in past). |
| **Issue (assign) batch vouchers** | POST | `/api/v1/vouchers/batch` | `{ vouchers: [{ beneficiaryId, amount, grantType?, expiryDays?, scheduledIssueAt?, buffrUserId? }, ...] }` | Each item validated; first validation error returns 400. |

**Guard rails (validation):**
- **Beneficiary:** Required, non-empty; must exist in `beneficiaries` table. Prevents unassigned vouchers. **Issuance to deceased:** Rejected — if beneficiary `status === 'deceased'`, issue returns an error (no new vouchers to deceased beneficiaries).
- **Amount:** Required, number, 1–1,000,000 NAD.
- **Grant type:** Required, one of `social_grant`, `subsidy`, `pension`, `disability`.
- **Expiry days:** Optional; if set, 1–365.
- **Scheduled issue date:** Optional; if set, must be a valid ISO date/datetime and not in the past. Sets `issued_at` and expiry is computed from that date.

---

## 2. Generate (Voucher Code & QR)

Voucher **generation** (code + QR) happens inside the **issue** flow. There is no separate “generate” endpoint.

- **Voucher code:** `VC-{prefix}-{suffix}` (e.g. `VC-9b1b1d9f-ecdw9mdx`), generated by `VoucherGenerator.generateVoucherCode(voucherId)`.
- **QR code:** Generated by `VoucherGenerator.generateQRCode(voucher)` (data: `voucher_id|voucher_code|amount|expiry_date`).
- **When:** During `POST /api/v1/vouchers` or `POST /api/v1/vouchers/batch` (via `VoucherService.issueVoucher` → `VoucherGenerator.createVoucher`).
- **Scheduled issuance:** If `scheduledIssueAt` is provided, `issued_at` is set to that date (and expiry is computed from it); voucher is still created immediately with status `issued`.

---

## 3. Voucher CRUD (Ketchup API)

| Operation | Method | Endpoint | Notes |
|-----------|--------|----------|--------|
| **List vouchers** | GET | `/api/v1/vouchers` | Query: `status`, `beneficiaryId`, `region`, `grantType`, `search`. |
| **Get voucher by ID** | GET | `/api/v1/vouchers/:id` | Returns voucher with beneficiary name (from JOIN if needed). |
| **Issue voucher** | POST | `/api/v1/vouchers` | Assign to beneficiary; generates code + QR. |
| **Issue batch** | POST | `/api/v1/vouchers/batch` | Multiple vouchers; each must have `beneficiaryId`. |
| **Update status** | PUT | `/api/v1/vouchers/:id/status` | Body: `{ status, redemptionMethod?, redeemedAt? }`. Used by webhooks (Buffr) and status monitor. |
| **Extend expiry** | PATCH | `/api/v1/vouchers/:id/extend` | Body: `{ expiryDate: ISO string }`. Only for issued/delivered. |
| **Cancel** | PATCH | `/api/v1/vouchers/:id/cancel` | —. Only for issued/delivered. |
| **Reissue** | POST | `/api/v1/vouchers/:id/reissue` | Body: `{ cancelOld?: boolean }`. Creates new voucher for same beneficiary; optionally cancels old. |
| **List vouchers by beneficiary** | GET | `/api/v1/beneficiaries/:id/vouchers` | All vouchers assigned to that beneficiary. |

**No DELETE:** Vouchers are not soft-deleted via API; only status is updated (e.g. `cancelled`, `expired`). Unassigned (orphan) vouchers are removed by migration, not by a public delete endpoint.

---

## 4. Distribute to Buffr App

Ketchup can send **already-issued** vouchers to Buffr (so they appear in the Buffr app for redemption).

| Operation | Method | Endpoint | Body | Notes |
|-----------|--------|----------|------|--------|
| **Distribute single voucher to Buffr** | POST | `/api/v1/distribution/disburse` | `{ voucherId }` | Calls Buffr API to send voucher; status updates via webhooks. |
| **Distribute batch to Buffr** | POST | `/api/v1/distribution/batch` | `{ voucherIds: string[] }` | Same for multiple vouchers. |

**Backend:** `DistributionEngine.distributeToBuffr(voucher)` → `BuffrAPIClient.sendVoucher(voucher)`. Buffr base URL: `BUFFR_API_URL` (env).

---

## 5. USSD (and SMS)

| Channel | Status | API | Notes |
|---------|--------|-----|--------|
| **Buffr** | Implemented | `POST /api/v1/distribution/disburse`, `POST /api/v1/distribution/batch` | Sends voucher to Buffr API. |
| **USSD** | Stub | — | `CommunicationService.sendUSSD(voucher)` exists but returns “not yet implemented”. No Ketchup API endpoint exposes USSD distribution. |
| **SMS** | Stub | `CommunicationService.sendSMS()` | Logs to `communication_log`; wire to SMS gateway via `SMS_GATEWAY_URL`. |
| **Buffr in-app** | Stub | `CommunicationService.sendBuffrInApp()` | Logs to `communication_log`; wire to Buffr notify via `BUFFR_NOTIFY_URL`. |

**Communication log:** Table `communication_log` (migration `011_communication_log.sql`) stores every outbound communication (channel: sms, ussd, buffr_in_app, email). **CommunicationService** (`backend/src/services/communication/CommunicationService.ts`) provides `sendSMS`, `sendUSSD`, `sendBuffrInApp`, and `notifyBeneficiary(channel, options)`. Use when extending/reissuing vouchers or sending expiry warnings (e.g. StatusMonitor.monitorExpiry can call CommunicationService to notify beneficiaries).

---

## 6. How Ketchup is notified (failed, expired, not redeemed)

- **Webhooks:** Buffr sends `voucher.redeemed`, `voucher.delivered`, `voucher.expired`, `voucher.cancelled`, and **`voucher.failed`** to `POST /api/v1/webhooks/buffr`. Backend updates voucher status and writes to `status_events` (triggered_by: webhook). Failed = delivery or redemption failed (e.g. invalid code, network error).
- **Status events:** All status changes (webhook, manual, system) are in `status_events`; Ketchup can query `GET /api/v1/status-events` and the **Live Activity Feed** on the dashboard.
- **Requires-attention:** `GET /api/v1/dashboard/requires-attention?expiringWithinDays=7` returns summary (failed, expired, expiring_soon), by_region, and sample voucher IDs. Ketchup Dashboard shows **Requires Attention** widget; sample IDs link to `/vouchers?view=<id>`. From voucher detail, Ketchup can **Extend**, **Cancel**, or **Reissue**.

## 7. Summary

| Capability | Ketchup has it? | Endpoint / note |
|------------|-----------------|------------------|
| **Assign voucher to beneficiary** | Yes | `POST /vouchers` (issue = assign); `beneficiaryId` required. |
| **Generate voucher code/QR** | Yes | Inside issue flow; no separate generate endpoint. |
| **Issue vouchers** | Yes | `POST /vouchers`, `POST /vouchers/batch`. |
| **CRUD vouchers** | Yes (no delete) | GET list/id, POST issue, PUT status; list by beneficiary. |
| **Extend / Cancel / Reissue** | Yes | PATCH `/vouchers/:id/extend`, PATCH `/vouchers/:id/cancel`, POST `/vouchers/:id/reissue`. |
| **Distribute to Buffr app** | Yes | `POST /distribution/disburse`, `POST /distribution/batch`. |
| **Requires-attention (alerts)** | Yes | `GET /dashboard/requires-attention`; Dashboard widget + voucher detail actions. |
| **Communications (SMS/USSD/Buffr)** | Stub | `CommunicationService` + `communication_log`; wire gateways when ready. |

All vouchers in the database are assigned (have a valid `beneficiary_id`). Migrations remove any orphan vouchers (no matching beneficiary).
